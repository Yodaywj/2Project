<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>案件实例</title>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../vendor/bootstrap-4.5.0-dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="../vendor/bootstrap-4.5.0-dist/css/bootstrap-table.min.css"/>
    <link rel="stylesheet" href="../css/laws.css" type="text/css"/>
    <link rel="stylesheet" href="../css/counter.css"/>
    <script src="../js/juqery.js"></script>
    <script src="../vendor/bootstrap-4.5.0-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../vendor/bootstrap-4.5.0-dist/js/bootstrap.js"></script>
    <script src="../vendor/bootstrap-4.5.0-dist/js/bootstrap-table.min.js"></script>
</head>
<body>
<div>
    <nav class=" navbar navbar-expand-md navbar-dark" style="background-color: rgb(115, 115, 115);">
        <a href="/" id="indexAll"><img src="../image/logo_1.png" width="70px" height="70px"></a>
        <div class="navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item active mr-2 ">
                    <div class="dropdown">
                        <button class="btn btn-dark text-white dropdown-toggle" type="button" id="dropdownMenuButton"
                                data-toggle="dropdown" aria-expanded="false">
                            民法典问答
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="../display/question1.html">问答一</a>
                            <a class="dropdown-item" href="../display/question2.html">问答二</a>
                            <a class="dropdown-item" href="../display/question3.html">问答三</a>
                        </div>
                    </div>
                </li>
                <li class="nav-item active mr-2">
                    <a class="btn btn-dark text-white" href="../display/laws_all.html">法律全文</a>
                </li>
                <li class="nav-item active mr-2">
                    <a class="btn btn-dark text-white" href="../display/lawCase.html">案件实例</a>
                </li>
                <li class="nav-item active mr-2">
                    <a class="btn btn-dark text-white" href="/user/question">问答记录</a>
                </li>
            </ul>
        </div>
        <div class="d-flex justify-content-end">
            <ul id="loginDisplay" class="navbar-nav">
                <li class="nav-item active border-right border-white">
                    <a class="badge text-white" href="/user/toLogin">登录</a>
                </li>
                <li class="nav-item active">
                    <a class="badge  text-white" href="/user/toRegister">注册</a>
                </li>
            </ul>
            &nbsp;&nbsp;
            <div id="sayHi" class="badge badge-info mr-3"></div>
            <div id="quit" class="btn badge badge-dark"></div>
            &nbsp;&nbsp;<div id="edit" class="btn badge badge-dark"></div>
        </div>
    </nav>

    <div id="cases" class="container-fluid">
        <div class="row">
            <div class="col" id="cases1"></div>
            <div class="col" id="cases2"></div>
        </div>
    </div>
</div>
<div class="mt-4 mr-4 d-block m-0 ml-auto" style="width: 300px">
    <div class="row">
        <button id="hideAll" class="btn btn-secondary btn-lg border">
            <span class="glyphicon glyphicon-repeat text-nowrap">展开</span>
        </button>
        <button id="pageChange" class="btn btn-secondary btn-lg border">
            <span class="glyphicon glyphicon-repeat text-nowrap">跳转</span>
        </button>
        <input id="inputPage" type="number" value="" class="form-control" autocomplete="off"
               min="1" maxlength="3" style="height: 48px;width: 100px;">
    </div>
    <div class="row mt-1">
        <nav aria-label="Page navigation example">
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link btn text-primary rounded-left" id="previousPage" aria-label="Previous" style="border-radius:0%;!important;">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item disabled" ><a id="currentPage" class="page-link text-dark" href="#">1</a></li>
                <li class="page-item">
                    <a class="page-link btn text-primary rounded-right" aria-label="Next" id="nextPage" style="border-radius:0%;!important;">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
<hr style="height: 1px; background-color: #17a2b8"/>
<div class="header container mb-3" style="margin-top: 20px !important;">
    <header>
        <h3 class="text-center mt-3 mb-3" id="commentBar">留言板</h3>
    </header>
    <table id="table-question" class="table-borderless"></table><!--onmouseup="cc();"-->
    <div id="toolbar" class="btn-group" style="width: 600px">
        <button id="refresh" class="btn btn-light border">
            <span class="glyphicon glyphicon-repeat text-nowrap">刷新</span>
        </button>
        <button id="btn-refresh" class="btn btn-light border">
            <span class="glyphicon glyphicon-repeat text-nowrap">删除</span>
        </button>
        <button id="find" class="btn btn-light border">
            <span class="glyphicon glyphicon-repeat text-nowrap">查找</span>
        </button>
        <input id="input2" type="number" value="" class="form-control ml-auto" autocomplete="off" placeholder="显示留言数"
               style="width: 200px">
        <input id="input1" type="search" class="form-control ml-auto" autocomplete="off" placeholder="查找对应用户"
               style="width: 200px">
        <input id="inputCID" type="search" class="form-control ml-auto" autocomplete="off" placeholder="查找文章ID"
               style="width: 200px">
    </div>
</div>
<div id="layout">
    <div id="test-editormd">
                <textarea id="caseChange" style="display:none;">
</textarea>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary mb-5" onclick="comment()" style="margin-left: 200px;">提交</button>
        <input id="casesNum" type="number" value="" class="form-control disabled" autocomplete="off" placeholder="输入文章ID"
               style="width: 130px; border-bottom-left-radius: 0px;border-top-left-radius: 0px;" min="1" max="1">
        <button id="toSingleCase" class="btn btn-primary mb-5">文章跳转</button>
        <button id="defaultCase" class="btn btn-primary mb-5 border-left">默认提交(文章id:0)</button>
    </div>
</div>
<link rel="stylesheet" href="../lib/editormd/css/editormd.css"/>
<script src="../lib/editormd/editormd.js"></script>
<script src="../lib/editormd/lib/marked.min.js"></script>
<script>
    let commentLink = (id)=>{
        window.location.href = "#toSingleCase";
        document.getElementById("casesNum").value = id;
    }
    const displayMap = new Map();
    let change = true;
    let renderArea = 'cases1';
    let casesNum = 0;
    let content = [];
    let judgment = [];
    let contentRender = [];
    let judgmentRender = []
    let groupIndex = 0;
    let maxPage=0;
    let currentPage = 1;
    let cases;
    let divNum = 4;
    let inputPage=1;
    let caseTime = [];
    let timeMap = new Map();
    let ccMap = new Map();
    $("#defaultCase").click(()=>{
      document.getElementById("casesNum").value = 0;
      comment();
    })
    $("#nextPage").click(()=>{
        if (maxPage>=currentPage+1){
            currentPage+=1;
            groupIndex=currentPage-1;
            renderArea = 'cases1';
            pageRender();
        }
    })
    $("#previousPage").click(()=>{
        if (1<=currentPage-1){
            currentPage-=1;
            groupIndex=currentPage-1;
            renderArea = 'cases1';
            pageRender();
        }
    })
    $("#pageChange").click(()=>{
        inputPage = Math.ceil(document.getElementById("inputPage").value);
        if (inputPage>maxPage||inputPage<1){
            $("#cases1").html("<h1 class='text-center'>空</h1>");
            $("#cases2").html("<h1 class='text-center'>共"+maxPage+"页</h1>");
            window.location.hash="#cases1"
            currentPage=0;
        }
        else if (inputPage!==currentPage){
            groupIndex=inputPage-1;
            currentPage=inputPage;
            renderArea = 'cases1';
            pageRender();
        }
    })
    const hideAll = () => {
        displayMap.forEach((val, key) => {
            if (change === true) {
                $("#hideAll").text("收起");
                if ($("#" + val).css("display") === "none") {
                    $("#" + key).click();
                }
            } else {
                $("#hideAll").text("展开");
                if ($("#" + val).css("display") === "block") {
                    $("#" + key).click();

                }
            }
        })
        change = !change;
    }
    $("#hideAll").click(() => {
        hideAll();
    });
    var casesGet = function () {
        $.ajax({
            url: '/comment/showNewCases',
            async: false,
            type: "POST",
            success: function (data) {
                cases = data.cases;
                for (let val in data.cases) {
                    data.cases[val]["content"] = marked.parse(data.cases[val]["content"]);
                    data.cases[val]["judgment"] = marked.parse(data.cases[val]["judgment"]);
                    data.cases[val]["time"] = marked.parse('###### '+data.cases[val]["time"]);
                    caseTime[casesNum] = data.cases[val]["time"]
                    content[casesNum] = data.cases[val]["content"];
                    judgment[casesNum] = data.cases[val]["judgment"]
                    caseMap = 'c' + data.cases[val]["id"];
                    judgmentMap = 'j' + data.cases[val]["id"];
                    btnMap = 'b' + data.cases[val]["id"];
                    displayMap.set(btnMap, judgmentMap);
                    timeMap.set(caseTime[casesNum],content[casesNum]);
                    let htmladd = '';
                    let htmlrender = '';
                    htmladd += '<div class="row-sm-6 my-4 mx-2" id="' + caseMap + '">';
                    htmladd += '<div class="card">';
                    htmladd += '<div class="card-body  overflow-auto" style="height: 385px;">';
                    htmladd += data.cases[val]["content"];
                    htmladd += '<span class="mt-3" style="display: block">'+caseTime[casesNum]+'</span>'
                    htmladd += '<button id="' + btnMap + '" class="btn btn-primary mt-2" type="button" data-toggle="collapse" data-target="#' + judgmentMap + '">查看</button>';
                    htmladd += '<button class="border-0 mb-3 float-right badge badge-secondary bg-secondary mt-2"><span  onclick="commentLink('+data.cases[val]["id"]+')" style="display: block;width: 50px;">'+data.cases[val]["id"]+'</span></button>'
                    htmladd += '</div>';
                    htmladd += '</div>';
                    htmladd += '</div>';
                    htmlrender += '<div class="row mx-4">';
                    htmlrender += '<div id="' + judgmentMap + '" class="col collapse" data-parent="#' + judgmentMap + '">';
                    htmlrender += '<div class="card">';
                    htmlrender += '<div class="card-body overflow-auto" style="height: 385px;">';
                    htmlrender += data.cases[val]["judgment"];
                    htmlrender += '</div>';
                    htmlrender += '</div>';
                    htmlrender += '</div>';
                    htmlrender += '</div>';
                    contentRender[casesNum] = htmladd;
                    judgmentRender[casesNum] = htmlrender;
                    ccMap.set(caseMap,htmladd);
                    ccMap.set(judgmentMap,htmlrender);
                    casesNum += 1;
                }
                maxPage = Math.ceil(casesNum/divNum);
                pageRender();
                document.getElementById("inputPage").setAttribute("placeholder","共"+maxPage+"页");
                document.getElementById("inputPage").setAttribute("max",maxPage);
                document.getElementById("casesNum").setAttribute("max",casesNum);
            },
            error: function () {
                alert("wrong");
            }
        })
    }
    const singleCaseRender = (commentId)=>{
        commentId = String(commentId);
        if (typeof ccMap.get("c"+commentId)==='undefined'&&commentId!=="0"){
            alert("ID错误")
        }else{
            if (commentId==="0"){
                window.location.hash="#commentBar"
                window.location.hash="#";
            }else{
                let cases1="";
                let cases2="";
                let a= "c"+commentId;
                cases1+=ccMap.get("c"+commentId);
                cases1+=ccMap.get("j"+commentId);
                $("#cases1").html(cases1);
                $("#cases2").html(cases2);
                currentPage=0;
                document.getElementById("currentPage").textContent="文章"+commentId;
                window.location.hash="#commentBar"
                window.location.hash="#";
            }
        }
    }
    $("#toSingleCase").click(()=>{
        const id = parseFloat(document.getElementById("casesNum").value);
        if (id<0||id!==Math.ceil(id)){
            alert("ID格式错误")
        }else {
            singleCaseRender(id);
        }
    });
    const pageRender = ()=>{
        let cases1="";
        let cases2="";
        let firstCases = divNum * groupIndex;
        for (let i = firstCases; i < firstCases + divNum; i++) {
            if (i<casesNum){
                if (renderArea === 'cases1') {
                    cases1+=contentRender[i];
                    cases1+=judgmentRender[i];
                    renderArea = 'cases2'
                } else {
                    cases2+=contentRender[i];
                    cases2+=judgmentRender[i];
                    renderArea = 'cases1'
                }
            }
        }
        $("#cases1").html(cases1);
        $("#cases2").html(cases2);
        document.getElementById("currentPage").textContent="第"+currentPage+"页";
        window.location.hash="#commentBar"
        window.location.hash="#c"+cases[divNum*groupIndex]["id"];
    }
    var dataGet = function () {
        $.ajax({
            url: '/comment/list',
            type: "POST",
            success: function (data) {
                for (let val in data.rows){
                    let CID=data.rows[val]["commentId"];
                    data.rows[val]["commentId"] = `<a href='#' onclick='singleCaseRender(${CID})'>${CID}</a>`
                }
                $('#table-question').bootstrapTable('load', data.rows);
            }
        })
    };
    var dataChange = function () {
        var num = document.getElementById("input2").value;
        var user = document.getElementById("input1").value;
        var commentId = document.getElementById("inputCID").value;
        if (num == '') {
            num = 0;
        }
        $.ajax({
            url: '/comment/listComment',
            type: "POST",
            async: true,
            data: {"num": num, "user": user,"commentId": commentId},
            success: function (data) {
                if (data.result) {
                    for (let val in data.rows){
                        let CID=data.rows[val]["commentId"];
                        data.rows[val]["commentId"] = `<a href='#' onclick='singleCaseRender(${CID})'>${CID}</a>`
                    }
                    $('#table-question').bootstrapTable('load', data.rows);
                } else {
                    alert('查询失败');
                }
            },
            error: function () {
                //请求出错处理
            }
        })
    };
    $('#find').click(function () {
        dataChange();
    });
    $('#refresh').click(function () {
        dataGet();
        document.getElementById("input2").value=""
        document.getElementById("input1").value=""
        document.getElementById("inputCID").value=""
    })
    const comment = function () {
        var correct = document.getElementById("caseChange").value;
        const commentId = parseFloat(document.getElementById("casesNum").value);
        correct = marked.parse(correct);
        if (correct.match(/^[ ]*$/)) {
            alert('不能为空');
        } else if (commentId<0||commentId!==Math.ceil(commentId)||(typeof ccMap.get("c"+commentId)==='undefined')&&commentId!==0){
            alert("ID错误")
        } else {
            $.ajax({
                url: '/comment/add',
                type: "POST",
                data: {"correct": correct,"commentId": commentId},
                success: function (data) {
                    if (data.result) {
                        alert(data.message);
                        dataGet();
                        //window.location.href='/comment/tolawCase'
                        //	$('#table-question').bootstrapTable('load', data.rows);
                    } else {
                        console.log(data);
                        alert(data.message)
                        if (data.message == '请先登录') {
                            window.location.href = '/user/toLogin';
                        }
                        //	alert(data.message, "错误", null);
                    }
                    dataGet();
                }
            })
        }
    }
    $('#btn-refresh').click(function () {
        var a = document.getElementsByClassName("selected")
        var id =a.item(0).children[2].innerHTML;
        let time = a.item(0).children[4].innerHTML;
        console.log(time,id)
        $.ajax({
            url: '/comment/del',
            type: "POST",
            data: {"id": id,"time":time},
            success: function (data) {
                if (data.result) {
                    alert('删除成功');
                    //window.location.href='/comment/tolawCase'
                    //	$('#table-question').bootstrapTable('load', data.rows);
                } else {
                    alert('只能删除自己的留言');
                    //window.location.href='/comment/tolawCase'
                    //	alert(data.message, "错误", null);
                }
                dataGet();
                //	$('#table-question').bootstrapTable('load', data.rows);
            },
            error: function () {
                alert('wrong1')
            }
        })
        //dataGet();
    });
    $(document).ready(function () {
        //检查session是否含用户名
        $.ajax({
            url: "/user/session",
            method: "POST",
            dataType: "json",
            success: function (res) {
                console.log(res.result);
                console.log(res.user);
                if (res.result) {
                    $("#loginDisplay").html("  ");
                    $("#sayHi").text("欢迎登陆，" + res.user.userName);
                    $("#quit").text("退出");
                    $("#center").text("用户中心");
                    if (res.user.admin === '管理员') {
                        $("#edit").text("用户管理");
                    }
                } else {
                    console.log(res.user);
                }
            }
        });
        $("#edit").click(function () {
            window.location.href = "/display/lawCaseEdit.html";
        });
        $("#center").click(function () {
            window.open("/user/question");
        });
        //退出按钮
        $("#quit").click(function () {
            $.ajax({
                url: "/user/logout",
                type: "get",
                dataType: "json",
                success: function () {
                    console.log("quit success");
                    $("#loginDisplay").html("\t\t\t\t\t<li class=\"nav-item active border-right border-white\">\n" +
                        "\t\t\t\t\t\t<a class=\"badge text-white\" href=\"../login/login.html\">登录</a>\n" +
                        "\t\t\t\t\t</li>\n" +
                        "\t\t\t\t\t<li class=\"nav-item active\">\n" +
                        "\t\t\t\t\t\t<a class=\"badge  text-white\" href=\"../login/register.html\">注册</a>\n" +
                        "\t\t\t\t\t</li>");
                    $("#quit").text("");
                }
            });
            window.location.reload()
        });
        //获取数据函数
        dataGet();
        $('#table-question').bootstrapTable({
            toolbar: '#toolbar',
            striped: true,
            singleSelect: true,
            idField: 'id',
            height: 500,
            columns: [
                {
                    title: "选择",
                    checkbox: true
                }, {
                    field: "commentId",
                    title: "文章ID",
                    align: "center",
                    sortable: "true"
                }, {
                    field: "userName",
                    title: "用户名",
                    align: "center",
                }, {
                    field: "correct",
                    title: "内容",
                    align: "center",
                    sortable: "true"
                }, {
                    field: "time",
                    title: "时间",
                    align: "center",
                    sortable: "true"
                }
            ]
        });
    });
    var testEditor;

    $(function () {
        testEditor = editormd("test-editormd", {
            width: "80%",
            height: 300,
            syncScrolling: "single",
            path: "../lib/editormd/lib/",
            saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
            emoji: true,
            tex: true,                   // 开启科学公式TeX语言支持，默认关闭
            flowChart: true,             // 开启流程图支持，默认关闭
            sequenceDiagram: true,       // 开启时序/序列图支持，默认关闭,
            //图片上传
            imageUpload: true,
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL: "/article/file/upload", //图片上传路径
            onload: function () {
                console.log('onload', this);
                casesGet();
            }
        });
    });
</script>
</body>
</html>

